import customtkinter as ctk
import os
import subprocess
import threading
import importlib.util
from tkinter import filedialog
import datetime
import sys

# Import LLM generator components
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from scripts_llm_config import get_config, get_all_llms, get_current_llm, save_llms, add_llm, update_llm, delete_llm, set_current_llm
from scripts.llm_generator import ScriptGenerator, GenerationError, APIError, ValidationError

# --- Configuration & Theme ---
ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("blue")

# Modern Color Palette
COLORS = {
    "bg_root": "#1a1a1a",       # Very dark grey for main background
    "bg_sidebar": "#111111",    # Black/Darker for sidebar
    "bg_card": "#242424",       # Card background
    "accent": "#1f6aa5",        # Primary Blue
    "accent_hover": "#144870",
    "text_main": "#ffffff",
    "text_sub": "#a0a0a0",
    "success": "#2b825b",       # Green
    "success_hover": "#1e5c40",
    "danger": "#c42b1c",        # Red
    "danger_hover": "#8a1f15",
    "border": "#333333"
}

class App(ctk.CTk):
    def __init__(self):
        super().__init__()

        self.title("Yofardev Toolbox")
        self.geometry("1200x850")
        self.configure(fg_color=COLORS["bg_root"])

        # Grid Layout
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)

        # --- State Variables ---
        self.scripts = self.get_scripts()
        self.current_script = None
        self.parameter_widgets = {}
        self.selected_files = []
        self.script_buttons = {} # Keep track of sidebar buttons for highlighting
        self.current_process = None  # Store running process for interruption
        self.showing_generator = False  # Track if generator UI is shown
        self.generator_widgets = {}  # Store generator UI widgets

        # --- UI Components ---
        self.create_sidebar()
        self.create_main_area()

    def create_sidebar(self):
        """Left Sidebar for Script Selection"""
        self.sidebar_frame = ctk.CTkFrame(self, width=280, corner_radius=0, fg_color=COLORS["bg_sidebar"])
        self.sidebar_frame.grid(row=0, column=0, rowspan=2, sticky="nsew")
        self.sidebar_frame.grid_rowconfigure(3, weight=1)

        # Logo Area
        self.logo_frame = ctk.CTkFrame(self.sidebar_frame, fg_color="transparent")
        self.logo_frame.grid(row=0, column=0, padx=25, pady=(30, 20), sticky="ew")
        
        self.logo_label = ctk.CTkLabel(self.logo_frame, text="YOFARDEV", 
                                       font=ctk.CTkFont(family="Roboto", size=22, weight="bold"),
                                       text_color=COLORS["text_main"], anchor="w")
        self.logo_label.pack(anchor="w")
        
        self.subtitle_label = ctk.CTkLabel(self.logo_frame, text="AUTOMATION TOOLBOX", 
                                       font=ctk.CTkFont(family="Roboto", size=10, weight="bold"),
                                       text_color=COLORS["accent"], anchor="w")
        self.subtitle_label.pack(anchor="w")

        # Separator
        self.sep = ctk.CTkFrame(self.sidebar_frame, height=1, fg_color=COLORS["border"])
        self.sep.grid(row=1, column=0, sticky="ew", padx=20, pady=(0, 15))

        # Search Box
        self.search_frame = ctk.CTkFrame(self.sidebar_frame, fg_color="transparent")
        self.search_frame.grid(row=1, column=0, sticky="ew", padx=15, pady=(0, 10))

        self.search_entry = ctk.CTkEntry(
            self.search_frame,
            placeholder_text="Search scripts...",
            fg_color=COLORS["bg_card"],
            border_color=COLORS["border"],
            height=35,
            font=ctk.CTkFont(size=12)
        )
        self.search_entry.pack(fill="x")
        self.search_entry.bind("<KeyRelease>", lambda e: self.filter_scripts(self.search_entry.get()))

        # Generate Script Button
        self.generate_script_btn = ctk.CTkButton(
            self.sidebar_frame,
            text="ðŸ¤– Generate Script",
            command=self.show_generator,
            fg_color=COLORS["accent"],
            hover_color=COLORS["accent_hover"],
            height=40,
            font=ctk.CTkFont(size=13, weight="bold"),
            corner_radius=6
        )
        self.generate_script_btn.grid(row=2, column=0, padx=15, pady=(0, 10), sticky="ew")

        # Scrollable Script List
        self.script_scroll = ctk.CTkScrollableFrame(self.sidebar_frame, fg_color="transparent", label_text=None)
        self.script_scroll.grid(row=3, column=0, padx=10, pady=(0, 10), sticky="nsew")

        # Populate Scripts
        if not self.scripts:
            ctk.CTkLabel(self.script_scroll, text="No scripts found in /scripts", 
                         text_color=COLORS["text_sub"]).pack(pady=20)

        for script in self.scripts:
            btn = ctk.CTkButton(
                self.script_scroll, 
                text=f"  {script['name']}", # indent text slightly
                command=lambda s=script: self.load_script_details(s),
                fg_color="transparent", 
                text_color=COLORS["text_sub"],
                hover_color=COLORS["bg_card"],
                anchor="w",
                height=45,
                font=ctk.CTkFont(size=13),
                corner_radius=6
            )
            btn.pack(fill="x", pady=2)
            self.script_buttons[script['name']] = btn

        # Footer Info with Settings Button
        self.footer_frame = ctk.CTkFrame(self.sidebar_frame, fg_color="transparent")
        self.footer_frame.grid(row=4, column=0, pady=10, sticky="ew")

        self.footer_lbl = ctk.CTkLabel(self.footer_frame, text="v1.2.0 â€¢ Ready",
                                       text_color=COLORS["border"], font=("Arial", 10))
        self.footer_lbl.pack(side="left", padx=15)

        self.settings_btn = ctk.CTkButton(
            self.footer_frame,
            text="âš™",
            width=30,
            height=30,
            font=ctk.CTkFont(size=14),
            fg_color="transparent",
            text_color=COLORS["border"],
            hover_color=COLORS["bg_card"],
            command=self.show_settings_modal,
            corner_radius=15
        )
        self.settings_btn.pack(side="right", padx=15)

    def create_main_area(self):
        """Right Main Area"""
        self.main_frame = ctk.CTkFrame(self, fg_color="transparent")
        self.main_frame.grid(row=0, column=1, sticky="nsew", padx=30, pady=30)
        
        self.main_frame.grid_rowconfigure(2, weight=1) 
        self.main_frame.grid_columnconfigure(0, weight=1)

        # 1. Header
        self.header_frame = ctk.CTkFrame(self.main_frame, fg_color="transparent")
        self.header_frame.grid(row=0, column=0, sticky="ew", pady=(0, 20))
        
        self.script_title_label = ctk.CTkLabel(self.header_frame, text="Select a Script", 
                                               font=ctk.CTkFont(family="Roboto", size=28, weight="bold"), 
                                               text_color=COLORS["text_main"], anchor="w")
        self.script_title_label.pack(fill="x")

        self.script_desc_label = ctk.CTkLabel(self.header_frame, text="Choose an automation tool from the sidebar to configure parameters and run tasks.", 
                                              font=ctk.CTkFont(size=14), text_color=COLORS["text_sub"], 
                                              anchor="w", justify="left", wraplength=800)
        self.script_desc_label.pack(fill="x", pady=(5, 0))

        # 2. Configuration Container (Grid)
        self.config_container = ctk.CTkFrame(self.main_frame, fg_color="transparent")
        self.config_container.grid(row=1, column=0, sticky="nsew", pady=(0, 20))
        self.config_container.grid_columnconfigure(0, weight=1, uniform="group1") 
        self.config_container.grid_columnconfigure(1, weight=1, uniform="group1")
        self.config_container.grid_rowconfigure(0, weight=1)

        # --- Card 1: Parameters ---
        self.params_card = ctk.CTkFrame(self.config_container, fg_color=COLORS["bg_card"], corner_radius=10, border_width=1, border_color=COLORS["border"])
        self.params_card.grid(row=0, column=0, sticky="nsew", padx=(0, 10))
        
        # Header
        p_header = ctk.CTkFrame(self.params_card, fg_color="transparent", height=40)
        p_header.pack(fill="x", padx=15, pady=(15,5))
        ctk.CTkLabel(p_header, text="Configuration", font=ctk.CTkFont(size=15, weight="bold"), text_color=COLORS["text_main"]).pack(side="left")

        # Scroll Area
        self.params_scroll = ctk.CTkScrollableFrame(self.params_card, fg_color="transparent")
        self.params_scroll.pack(fill="both", expand=True, padx=5, pady=5)
        self.empty_params_lbl = ctk.CTkLabel(self.params_scroll, text="No parameters available.", text_color=COLORS["border"])
        self.empty_params_lbl.pack(pady=40)

        # --- Card 2: Files ---
        self.files_card = ctk.CTkFrame(self.config_container, fg_color=COLORS["bg_card"], corner_radius=10, border_width=1, border_color=COLORS["border"])
        self.files_card.grid(row=0, column=1, sticky="nsew", padx=(10, 0))

        # Header with Buttons
        f_header = ctk.CTkFrame(self.files_card, fg_color="transparent", height=40)
        f_header.pack(fill="x", padx=15, pady=(15,5))
        ctk.CTkLabel(f_header, text="Input Files", font=ctk.CTkFont(size=15, weight="bold"), text_color=COLORS["text_main"]).pack(side="left")
        
        self.clear_files_btn = ctk.CTkButton(f_header, text="Clear All", width=60, height=24,
                                             font=ctk.CTkFont(size=11),
                                             fg_color="transparent", text_color=COLORS["danger"], hover_color=COLORS["bg_root"], 
                                             command=self.clear_files, state="disabled")
        self.clear_files_btn.pack(side="right")

        # File Action Buttons
        self.file_btn_frame = ctk.CTkFrame(self.files_card, fg_color="transparent")
        self.file_btn_frame.pack(fill="x", padx=15, pady=(0, 10))
        
        self.add_file_btn = ctk.CTkButton(self.file_btn_frame, text="+ Add Files", height=32, fg_color=COLORS["accent"], hover_color=COLORS["accent_hover"], command=self.add_files, state="disabled")
        self.add_file_btn.pack(side="left", fill="x", expand=True, padx=(0, 5))
        
        self.add_folder_btn = ctk.CTkButton(self.file_btn_frame, text="+ Add Folder", height=32, fg_color=COLORS["bg_root"], hover_color="#000000", command=self.add_folder, state="disabled")
        self.add_folder_btn.pack(side="left", fill="x", expand=True, padx=(5, 0))

        # File List
        self.file_list_scroll = ctk.CTkScrollableFrame(self.files_card, fg_color=COLORS["bg_root"], height=150, corner_radius=6)
        self.file_list_scroll.pack(fill="both", expand=True, padx=15, pady=(0, 15))
        
        self.file_list_placeholder = ctk.CTkLabel(self.file_list_scroll, text="Drag and drop not supported.\nPlease use buttons above.", text_color=COLORS["border"])
        self.file_list_placeholder.pack(pady=40)

        # 3. Console & Execution
        self.bottom_frame = ctk.CTkFrame(self.main_frame, fg_color="transparent")
        self.bottom_frame.grid(row=2, column=0, sticky="nsew")
        self.bottom_frame.grid_rowconfigure(1, weight=1)
        self.bottom_frame.grid_columnconfigure(0, weight=1)

        # Run Button Bar
        self.action_bar = ctk.CTkFrame(self.bottom_frame, fg_color="transparent")
        self.action_bar.grid(row=0, column=0, sticky="ew", pady=(0, 10))

        self.run_button = ctk.CTkButton(self.action_bar, text="RUN SCRIPT", height=50,
                                        font=ctk.CTkFont(size=15, weight="bold"),
                                        fg_color=COLORS["success"], hover_color=COLORS["success_hover"],
                                        corner_radius=8,
                                        state="disabled", command=self.run_script)
        self.run_button.pack(side="left", fill="x", expand=True, padx=(0, 10))

        self.stop_button = ctk.CTkButton(self.action_bar, text="STOP", height=50,
                                         font=ctk.CTkFont(size=15, weight="bold"),
                                         fg_color=COLORS["danger"], hover_color=COLORS["danger_hover"],
                                         corner_radius=8, width=150,
                                         state="disabled", command=self.stop_script)
        self.stop_button.pack(side="right")

        # Console Window
        self.output_console = ctk.CTkTextbox(self.bottom_frame, 
                                             font=("Consolas", 13), 
                                             fg_color="#0f0f0f", 
                                             text_color="#dcdcdc",
                                             border_width=1, border_color=COLORS["border"],
                                             activate_scrollbars=True)
        self.output_console.grid(row=1, column=0, sticky="nsew")
        self.output_console.insert("1.0", "Waiting for input...\n")
        self.output_console.configure(state="disabled")

    # --- Logic Methods ---

    def get_scripts(self):
        scripts = []
        scripts_dir = "scripts"
        if not os.path.exists(scripts_dir):
            os.makedirs(scripts_dir)

        # Files to skip (utility modules)
        skip_files = {"llm_generator.py", "__init__.py"}

        if os.path.exists(scripts_dir) and os.path.isdir(scripts_dir):
            for filename in sorted(os.listdir(scripts_dir)):
                if filename.endswith(".py") and not filename.startswith("__") and filename not in skip_files:
                    try:
                        script_path = os.path.join(scripts_dir, filename)
                        spec = importlib.util.spec_from_file_location(filename[:-3], script_path)
                        module = importlib.util.module_from_spec(spec)
                        spec.loader.exec_module(module)
                        scripts.append({
                            "name": getattr(module, "NAME", filename[:-3]),
                            "filename": filename[:-3],
                            "description": getattr(module, "DESCRIPTION", "No description available."),
                            "input_types": getattr(module, "INPUT_TYPES", ""),
                            "parameters": getattr(module, "PARAMETERS", []),
                            "accepts_multiple_files": getattr(module, "ACCEPTS_MULTIPLE_FILES", True),
                        })
                    except Exception as e:
                        print(f"Error loading {filename}: {e}")
        return scripts

    def filter_scripts(self, search_query):
        """Filter scripts based on search query"""
        search_query = search_query.lower().strip()

        # Remove existing "no results" label if present
        for widget in self.script_scroll.winfo_children():
            if isinstance(widget, ctk.CTkLabel) and widget.cget("text").startswith("No scripts"):
                widget.destroy()

        visible_count = 0
        for script_name, button in self.script_buttons.items():
            # Search in script name and description
            script_data = next((s for s in self.scripts if s['name'] == script_name), None)
            if script_data:
                name_matches = search_query in script_name.lower()
                desc_matches = search_query in script_data['description'].lower()

                if search_query == "" or name_matches or desc_matches:
                    # Show button
                    button.pack(fill="x", pady=2)
                    visible_count += 1
                else:
                    # Hide button
                    button.pack_forget()

        # Show "no results" message if no scripts match
        if visible_count == 0 and search_query != "":
            ctk.CTkLabel(
                self.script_scroll,
                text=f"No scripts match '{search_query}'",
                text_color=COLORS["text_sub"]
            ).pack(pady=20)

    def load_script_details(self, script):
        # UI Update for Sidebar Selection (Highlight active)
        if self.current_script:
             old_btn = self.script_buttons.get(self.current_script['name'])
             if old_btn: old_btn.configure(fg_color="transparent", text_color=COLORS["text_sub"])
        
        self.current_script = script
        new_btn = self.script_buttons.get(script['name'])
        if new_btn: new_btn.configure(fg_color=COLORS["accent"], text_color="#ffffff")

        # Update Header
        self.script_title_label.configure(text=script['name'])
        self.script_desc_label.configure(text=script['description'])
        
        # Button Config
        if not script.get('accepts_multiple_files', True):
            self.add_file_btn.configure(text="Select File", command=self.add_file)
            self.add_folder_btn.configure(state="disabled")
        else:
            self.add_file_btn.configure(text="+ Add Files", command=self.add_files)
            self.add_folder_btn.configure(state="normal")

        self.add_file_btn.configure(state="normal")
        self.clear_files_btn.configure(state="normal")
        self.run_button.configure(state="normal", text="RUN SCRIPT", fg_color=COLORS["success"])

        # Clear Params
        for widget in self.params_scroll.winfo_children():
            widget.destroy()
        self.parameter_widgets = {}

        # Build Params
        if not script['parameters']:
            self.empty_params_lbl = ctk.CTkLabel(self.params_scroll, text="No parameters required.", text_color=COLORS["border"])
            self.empty_params_lbl.pack(pady=20)
        
        for param in script['parameters']:
            # Parameter Row Container
            param_frame = ctk.CTkFrame(self.params_scroll, fg_color="transparent")
            param_frame.pack(fill="x", pady=8, padx=5)

            # Label
            label_text = param.get('label', param['name'])
            lbl = ctk.CTkLabel(param_frame, text=label_text, font=ctk.CTkFont(size=12, weight="bold"), anchor="w")
            lbl.pack(fill="x", pady=(0, 2))

            # Input Widget
            if param['type'] == 'choice':
                widget = ctk.CTkOptionMenu(param_frame, values=param['choices'], fg_color=COLORS["bg_root"], button_color=COLORS["accent"])
                widget.set(param['default'])
            elif param['type'] in ['integer', 'int', 'float', 'string']:
                widget = ctk.CTkEntry(param_frame, fg_color=COLORS["bg_root"], border_color=COLORS["border"])
                widget.insert(0, str(param.get('default', '')))
            elif param['type'] in ['boolean', 'bool']:
                widget = ctk.CTkSwitch(param_frame, text="Enable", progress_color=COLORS["success"])
                if param.get('default'):
                    widget.select()
            else:
                widget = ctk.CTkEntry(param_frame, fg_color=COLORS["bg_root"])

            widget.pack(fill="x")
            self.parameter_widgets[param['name']] = widget
            
            # --- IMPROVEMENT HERE ---
            # Description (Small text below, now with wrapping)
            if param.get("description"):
                desc_lbl = ctk.CTkLabel(
                    param_frame, 
                    text=param.get("description"), 
                    text_color=COLORS["text_sub"], 
                    font=ctk.CTkFont(size=11), 
                    anchor="w",
                    justify="left",  # Aligns the multi-line text to the left
                    wraplength=380   # Forces text to wrap within the container width
                )
                desc_lbl.pack(fill="x", pady=(4, 2))

        self.selected_files = []
        self.update_file_list_ui()

    def update_file_list_ui(self):
        for widget in self.file_list_scroll.winfo_children():
            widget.destroy()
            
        if not self.selected_files:
            self.file_list_placeholder = ctk.CTkLabel(self.file_list_scroll, text="No files selected", text_color=COLORS["border"])
            self.file_list_placeholder.pack(pady=40)
            self.run_button.configure(state="disabled", fg_color=COLORS["border"])
            return
        
        # Re-enable run button if we have files
        self.run_button.configure(state="normal", fg_color=COLORS["success"])

        for i, file_path in enumerate(self.selected_files):
            row = ctk.CTkFrame(self.file_list_scroll, fg_color=COLORS["bg_card"], height=35)
            row.pack(fill="x", pady=2)
            
            # Icon (Text based)
            icon = ctk.CTkLabel(row, text="ðŸ“„", width=30, anchor="center")
            icon.pack(side="left")

            name = os.path.basename(file_path)
            lbl = ctk.CTkLabel(row, text=name, anchor="w", font=ctk.CTkFont(size=12))
            lbl.pack(side="left", padx=5, fill="x", expand=True)
            
            del_btn = ctk.CTkButton(row, text="Ã—", width=30, height=25, 
                                    fg_color="transparent", hover_color=COLORS["danger"], 
                                    text_color=COLORS["danger"],
                                    font=("Arial", 16, "bold"),
                                    command=lambda idx=i: self.remove_file(idx))
            del_btn.pack(side="right", padx=5, pady=5)

    def remove_file(self, index):
        if 0 <= index < len(self.selected_files):
            del self.selected_files[index]
            self.update_file_list_ui()

    def clear_files(self):
        self.selected_files = []
        self.update_file_list_ui()

    def get_file_extensions(self):
        if not self.current_script or not self.current_script['input_types']:
            return []
        try:
            parts = self.current_script['input_types'].split('(')
            if len(parts) > 1:
                exts_str = parts[1].replace(')', '').replace('*', '').replace(',', '')
                return exts_str.split()
        except:
            pass
        return []

    def add_file(self):
        if not self.current_script: return
        filetypes = self._get_filetypes()
        file = filedialog.askopenfilename(filetypes=filetypes)
        if file:
            self.selected_files = [file]
            self.update_file_list_ui()

    def add_files(self):
        if not self.current_script: return
        filetypes = self._get_filetypes()
        files = filedialog.askopenfilenames(filetypes=filetypes)
        if files:
            for file in files:
                if file not in self.selected_files:
                    self.selected_files.append(file)
            self.update_file_list_ui()

    def _get_filetypes(self):
        filetypes = []
        input_str = self.current_script.get('input_types', '')
        if input_str:
            parts = input_str.split('(')
            if len(parts) > 1:
                desc = parts[0].strip()
                exts = parts[1].replace(')', '')
                filetypes.append((desc, exts))
        filetypes.append(("All Files", "*.*"))
        return filetypes

    def add_folder(self):
        if not self.current_script: return
        folder = filedialog.askdirectory()
        if not folder: return

        target_exts = self.get_file_extensions()
        added_count = 0
        for root, _, files in os.walk(folder):
            for file in files:
                if not target_exts or any(file.lower().endswith(ext.lower()) for ext in target_exts):
                    full_path = os.path.join(root, file)
                    if full_path not in self.selected_files:
                        self.selected_files.append(full_path)
                        added_count += 1
        if added_count > 0:
            self.update_file_list_ui()

    def run_script(self):
        if not self.current_script: return

        script_filename = self.current_script['filename']
        script_path = os.path.join("scripts", f"{script_filename}.py")
        
        # Output configuration
        script_name_slug = self.current_script['name'].lower().replace(' ', '_')
        downloads_dir = os.path.expanduser("~/Downloads")
        output_dir = os.path.join(downloads_dir, script_name_slug)
        os.makedirs(output_dir, exist_ok=True)
        
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        output_filename = f"{timestamp}.jpg"
        output_path = os.path.join(output_dir, output_filename)

        command = ["python", script_path]
        if not self.current_script.get('accepts_multiple_files', True):
            if self.selected_files: command.append(self.selected_files[0])
            command.append(output_path)
        else:
            command.extend(self.selected_files)

        for name, widget in self.parameter_widgets.items():
            param_def = next((p for p in self.current_script['parameters'] if p['name'] == name), None)
            if param_def and param_def['type'] in ['boolean', 'bool']:
                if widget.get() == 1: command.append(f"--{name}")
            else:
                value = widget.get()
                command.append(f"--{name}")
                command.append(str(value))

        # UI Feedback
        self.run_button.configure(state="disabled", text="PROCESSING...", fg_color=COLORS["accent"])
        self.stop_button.configure(state="normal")
        self.output_console.configure(state="normal")
        self.output_console.delete("1.0", "end")
        self.output_console.insert("end", f"> Initializing {self.current_script['name']}...\n", "info")
        self.output_console.insert("end", f"> Output Path: {output_path}\n\n")
        self.output_console.see("end")
        self.output_console.configure(state="disabled")

        threading.Thread(target=self._run_process, args=(command, output_dir), daemon=True).start()

    def _run_process(self, command, output_dir):
        try:
            process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                                     text=True, bufsize=1, universal_newlines=True)
            self.current_process = process  # Store process for interruption
            
            def read_stream(stream):
                for line in iter(stream.readline, ''):
                    self.output_console.configure(state="normal")
                    self.output_console.insert("end", "  " + line) # Indent output
                    self.output_console.see("end")
                    self.output_console.configure(state="disabled")
                stream.close()

            read_stream(process.stdout)
            read_stream(process.stderr)
            
            process.wait()
            self.after(0, lambda: self._process_finished(process.returncode, output_dir))
            
        except Exception as e:
             self.after(0, lambda: self._log_error(str(e)))
             self.after(0, lambda: self._process_finished(-1, None))

    def _log_error(self, msg):
        self.output_console.configure(state="normal")
        self.output_console.insert("end", f"\nERROR: {msg}\n")
        self.output_console.configure(state="disabled")

    def _process_finished(self, return_code, output_dir):
        self.current_process = None  # Clear process reference
        self.stop_button.configure(state="disabled")  # Disable stop button
        self.output_console.configure(state="normal")
        if return_code == 0:
            self.output_console.insert("end", f"\n> SUCCESS: Task completed.\n")
            btn_color = COLORS["success"]
            btn_text = "RUN SCRIPT"
            if output_dir:
                self.output_console.insert("end", f"> Opening output folder...\n")
                try:
                    if sys.platform == "win32":
                        os.startfile(output_dir)
                    elif sys.platform == "darwin":
                        subprocess.Popen(["open", output_dir])
                    else:
                        subprocess.Popen(["xdg-open", output_dir])
                except Exception as e:
                    self._log_error(f"Could not open output folder: {e}")
        else:
            self.output_console.insert("end", f"\n> FAILED: Exit code {return_code}.\n")
            btn_color = COLORS["danger"]
            btn_text = "RETRY"
            
        self.output_console.see("end")
        self.output_console.configure(state="disabled")
        self.run_button.configure(state="normal", text=btn_text, fg_color=btn_color)

    def stop_script(self):
        """Interrupt the currently running script."""
        if self.current_process:
            self.output_console.configure(state="normal")
            self.output_console.insert("end", f"\n> Interrupting script...\n")
            self.output_console.see("end")
            self.output_console.configure(state="disabled")

            try:
                self.current_process.terminate()
                # Give process a moment to terminate gracefully, then kill
                try:
                    self.current_process.wait(timeout=2)
                except subprocess.TimeoutExpired:
                    self.current_process.kill()

                self.output_console.configure(state="normal")
                self.output_console.insert("end", f"\n> Script interrupted by user.\n")
                self.output_console.see("end")
                self.output_console.configure(state="disabled")
            except Exception as e:
                self.output_console.configure(state="normal")
                self.output_console.insert("end", f"\n> Error stopping script: {e}\n")
                self.output_console.see("end")
                self.output_console.configure(state="disabled")

            self.current_process = None
            self.stop_button.configure(state="disabled")
            self.run_button.configure(state="normal", text="RUN SCRIPT", fg_color=COLORS["success"])

    # --- LLM Script Generator Methods ---

    def show_settings_modal(self):
        """Show the LLM settings modal for managing multiple LLM configurations."""
        # Create modal window
        settings_window = ctk.CTkToplevel(self)
        settings_window.title("LLM Settings")
        settings_window.geometry("700x550")
        settings_window.configure(fg_color=COLORS["bg_root"])
        settings_window.transient(self)
        settings_window.grab_set()

        # Center the window
        settings_window.update_idletasks()
        x = (settings_window.winfo_screenwidth() // 2) - 350
        y = (settings_window.winfo_screenheight() // 2) - 275
        settings_window.geometry(f"700x550+{x}+{y}")

        # Header
        header_frame = ctk.CTkFrame(settings_window, fg_color="transparent")
        header_frame.pack(fill="x", padx=30, pady=(30, 20))

        ctk.CTkLabel(header_frame, text="ðŸ”§ LLM Configuration",
                    font=ctk.CTkFont(size=20, weight="bold"),
                    text_color=COLORS["text_main"]).pack(anchor="w")

        ctk.CTkLabel(header_frame, text="Add, edit, and select LLM providers for script generation",
                    font=ctk.CTkFont(size=12),
                    text_color=COLORS["text_sub"]).pack(anchor="w", pady=(5, 0))

        # Main content - two columns
        content_frame = ctk.CTkFrame(settings_window, fg_color="transparent")
        content_frame.pack(fill="both", expand=True, padx=30, pady=(0, 20))
        content_frame.grid_columnconfigure(0, weight=1)
        content_frame.grid_columnconfigure(1, weight=1)

        # Left column - LLM list
        left_frame = ctk.CTkFrame(content_frame, fg_color="transparent")
        left_frame.grid(row=0, column=0, sticky="nsew", padx=(0, 10))

        ctk.CTkLabel(left_frame, text="Your LLMs",
                    font=ctk.CTkFont(size=14, weight="bold"),
                    text_color=COLORS["text_main"], anchor="w").pack(fill="x", pady=(0, 10))

        # Scrollable list
        list_frame = ctk.CTkScrollableFrame(left_frame, fg_color=COLORS["bg_card"],
                                            corner_radius=10, border_width=1, border_color=COLORS["border"],
                                            height=300)
        list_frame.pack(fill="both", expand=True)

        # Right column - Edit form
        right_frame = ctk.CTkFrame(content_frame, fg_color=COLORS["bg_card"],
                                   corner_radius=10, border_width=1, border_color=COLORS["border"])
        right_frame.grid(row=0, column=1, sticky="nsew", padx=(10, 0))

        # Form header
        form_header = ctk.CTkFrame(right_frame, fg_color="transparent")
        form_header.pack(fill="x", padx=15, pady=(15, 10))

        ctk.CTkLabel(form_header, text="LLM Details",
                    font=ctk.CTkFont(size=14, weight="bold"),
                    text_color=COLORS["text_main"]).pack(side="left")

        # State
        editing_llm_id = [None]  # Use list for mutability in closure

        # Form fields
        form_content = ctk.CTkScrollableFrame(right_frame, fg_color="transparent")
        form_content.pack(fill="both", expand=True, padx=15, pady=(0, 15))

        # Name
        ctk.CTkLabel(form_content, text="Name",
                    font=ctk.CTkFont(size=11, weight="bold"),
                    text_color=COLORS["text_sub"], anchor="w").pack(fill="x", pady=(0, 3))

        name_entry = ctk.CTkEntry(form_content, fg_color=COLORS["bg_root"],
                                  border_color=COLORS["border"], height=35)
        name_entry.pack(fill="x", pady=(0, 12))

        # Endpoint
        ctk.CTkLabel(form_content, text="API Endpoint",
                    font=ctk.CTkFont(size=11, weight="bold"),
                    text_color=COLORS["text_sub"], anchor="w").pack(fill="x", pady=(0, 3))

        endpoint_entry = ctk.CTkEntry(form_content, fg_color=COLORS["bg_root"],
                                      border_color=COLORS["border"], height=35)
        endpoint_entry.pack(fill="x", pady=(0, 12))

        # Model
        ctk.CTkLabel(form_content, text="Model Name",
                    font=ctk.CTkFont(size=11, weight="bold"),
                    text_color=COLORS["text_sub"], anchor="w").pack(fill="x", pady=(0, 3))

        model_entry = ctk.CTkEntry(form_content, fg_color=COLORS["bg_root"],
                                   border_color=COLORS["border"], height=35)
        model_entry.pack(fill="x", pady=(0, 12))

        # API Key
        ctk.CTkLabel(form_content, text="API Key",
                    font=ctk.CTkFont(size=11, weight="bold"),
                    text_color=COLORS["text_sub"], anchor="w").pack(fill="x", pady=(0, 3))

        api_key_entry = ctk.CTkEntry(form_content, fg_color=COLORS["bg_root"],
                                    border_color=COLORS["border"], height=35, show="â€¢")
        api_key_entry.pack(fill="x", pady=(0, 5))

        # Show/hide key
        show_key_var = ctk.BooleanVar(value=False)
        ctk.CTkCheckBox(form_content, text="Show API Key", variable=show_key_var,
                       command=lambda: api_key_entry.configure(show="" if show_key_var.get() else "â€¢"),
                       checkbox_width=16, checkbox_height=16, fg_color="transparent",
                       checkmark_color=COLORS["accent"]).pack(anchor="w", pady=(0, 12))

        # Action buttons (outside scrollable area, always visible)
        action_container = ctk.CTkFrame(right_frame, fg_color="transparent")
        action_container.pack(fill="x", padx=15, pady=(0, 15))

        # Mode label
        mode_label = ctk.CTkLabel(action_container, text="Adding new LLM",
                                 font=ctk.CTkFont(size=11), text_color=COLORS["text_sub"])
        mode_label.pack(anchor="w", pady=(0, 8))

        # Button row
        button_row = ctk.CTkFrame(action_container, fg_color="transparent")
        button_row.pack(fill="x")

        cancel_btn = ctk.CTkButton(button_row, text="Cancel", width=90,
                                  command=lambda: clear_form(),
                                  fg_color=COLORS["bg_card"], hover_color=COLORS["border"],
                                  text_color=COLORS["text_main"], font=ctk.CTkFont(size=11))
        cancel_btn.pack(side="left", padx=(0, 8))

        save_btn = ctk.CTkButton(button_row, text="Add LLM", width=120,
                                command=lambda: save_form(),
                                fg_color=COLORS["success"], hover_color=COLORS["success_hover"],
                                font=ctk.CTkFont(size=12, weight="bold"))
        save_btn.pack(side="left")

        # Add new button at bottom of left column
        add_new_btn = ctk.CTkButton(left_frame, text="+ Add New LLM",
                                   command=lambda: start_adding(),
                                   fg_color=COLORS["success"], hover_color=COLORS["success_hover"],
                                   height=35, font=ctk.CTkFont(size=12, weight="bold"))
        add_new_btn.pack(fill="x", pady=(10, 0))

        # Close button at bottom
        close_btn = ctk.CTkButton(settings_window, text="Close", command=settings_window.destroy,
                                 fg_color=COLORS["bg_card"], hover_color=COLORS["border"],
                                 text_color=COLORS["text_main"], width=100)
        close_btn.pack(pady=(0, 20))

        # Functions
        def refresh_llm_list():
            """Refresh the LLM list display."""
            # Clear list
            for widget in list_frame.winfo_children():
                widget.destroy()

            llms = get_all_llms()

            for llm in llms:
                item_frame = ctk.CTkFrame(list_frame, fg_color=COLORS["bg_root"], corner_radius=6)
                item_frame.pack(fill="x", pady=5, padx=5)

                # Left content
                content_frame = ctk.CTkFrame(item_frame, fg_color="transparent")
                content_frame.pack(side="left", fill="both", expand=True, padx=10, pady=8)

                # Name row
                name_row = ctk.CTkFrame(content_frame, fg_color="transparent")
                name_row.pack(fill="x")

                ctk.CTkLabel(name_row, text=llm.get("name", "Unnamed"),
                            font=ctk.CTkFont(size=12, weight="bold"),
                            text_color=COLORS["text_main"], anchor="w").pack(side="left")

                if llm.get("is_current"):
                    ctk.CTkLabel(name_row, text="â— Active",
                                font=ctk.CTkFont(size=10), text_color=COLORS["success"]).pack(side="left", padx=(8, 0))

                # Model row
                ctk.CTkLabel(content_frame, text=f"Model: {llm.get('model', 'N/A')}",
                            font=ctk.CTkFont(size=10), text_color=COLORS["text_sub"],
                            anchor="w").pack(fill="x", pady=(2, 0))

                # Right actions
                actions_frame = ctk.CTkFrame(item_frame, fg_color="transparent")
                actions_frame.pack(side="right", padx=5)

                # Select button
                if not llm.get("is_current"):
                    select_btn = ctk.CTkButton(actions_frame, text="â–¸", width=30, height=30,
                                               font=ctk.CTkFont(size=12),
                                               fg_color="transparent", hover_color=COLORS["bg_card"],
                                               text_color=COLORS["success"],
                                               command=lambda lid=llm.get("id"): select_llm(lid))
                    select_btn.pack(side="left", padx=2)

                # Edit button
                edit_btn = ctk.CTkButton(actions_frame, text="âœŽ", width=30, height=30,
                                         font=ctk.CTkFont(size=12),
                                         fg_color="transparent", hover_color=COLORS["bg_card"],
                                         text_color=COLORS["accent"],
                                         command=lambda lid=llm.get("id"): edit_llm(lid))
                edit_btn.pack(side="left", padx=2)

                # Delete button (only if more than 1 LLM)
                if len(llms) > 1:
                    delete_btn = ctk.CTkButton(actions_frame, text="Ã—", width=30, height=30,
                                               font=ctk.CTkFont(size=14, weight="bold"),
                                               fg_color="transparent", hover_color=COLORS["danger"],
                                               text_color=COLORS["danger"],
                                               command=lambda lid=llm.get("id"): delete_llm_item(lid))
                    delete_btn.pack(side="left", padx=2)

        def select_llm(llm_id):
            """Set an LLM as current."""
            if set_current_llm(llm_id):
                refresh_llm_list()
                clear_form()

        def edit_llm(llm_id):
            """Load an LLM into the form for editing."""
            llms = get_all_llms()
            llm = next((l for l in llms if l.get("id") == llm_id), None)
            if llm:
                editing_llm_id[0] = llm_id
                name_entry.delete(0, "end")
                name_entry.insert(0, llm.get("name", ""))
                endpoint_entry.delete(0, "end")
                endpoint_entry.insert(0, llm.get("endpoint", ""))
                model_entry.delete(0, "end")
                model_entry.insert(0, llm.get("model", ""))
                api_key_entry.delete(0, "end")
                api_key_entry.insert(0, llm.get("api_key", ""))
                # Update UI for edit mode
                mode_label.configure(text=f"Editing '{llm.get('name', 'Unnamed')}'")
                save_btn.configure(text="Update LLM", fg_color=COLORS["accent"], hover_color=COLORS["accent_hover"])

        def delete_llm_item(llm_id):
            """Delete an LLM."""
            llms = get_all_llms()
            if len(llms) <= 1:
                return  # Don't allow deleting last LLM

            # Find name for confirmation
            llm = next((l for l in llms if l.get("id") == llm_id), None)
            if llm:
                name = llm.get("name", "this LLM")

                # Simple confirmation via toplevel
                confirm = ctk.CTkToplevel(settings_window)
                confirm.title("Confirm Delete")
                confirm.geometry("300x120")
                confirm.configure(fg_color=COLORS["bg_root"])
                confirm.transient(settings_window)
                confirm.grab_set()

                ctk.CTkLabel(confirm, text=f"Delete '{name}'?",
                            font=ctk.CTkFont(size=13), text_color=COLORS["text_main"]).pack(pady=(20, 10))

                btn_frame = ctk.CTkFrame(confirm, fg_color="transparent")
                btn_frame.pack()

                def do_delete():
                    if delete_llm(llm_id):
                        refresh_llm_list()
                        if editing_llm_id[0] == llm_id:
                            clear_form()
                    confirm.destroy()

                ctk.CTkButton(btn_frame, text="Delete", command=do_delete,
                             fg_color=COLORS["danger"], hover_color=COLORS["danger_hover"], width=80).pack(side="left", padx=5)
                ctk.CTkButton(btn_frame, text="Cancel", command=confirm.destroy,
                             fg_color=COLORS["bg_card"], hover_color=COLORS["border"], width=80).pack(side="left", padx=5)

        def start_adding():
            """Clear form to add a new LLM."""
            editing_llm_id[0] = None
            clear_form()
            name_entry.focus()

        def clear_form():
            """Clear the form."""
            editing_llm_id[0] = None
            name_entry.delete(0, "end")
            endpoint_entry.delete(0, "end")
            model_entry.delete(0, "end")
            api_key_entry.delete(0, "end")
            # Reset UI for add mode
            mode_label.configure(text="Adding new LLM")
            save_btn.configure(text="Add LLM", fg_color=COLORS["success"], hover_color=COLORS["success_hover"])

        def save_form():
            """Save the form data."""
            name = name_entry.get().strip()
            endpoint = endpoint_entry.get().strip()
            model = model_entry.get().strip()
            api_key = api_key_entry.get().strip()

            if not name or not endpoint or not model:
                ctk.CTkLabel(form_content, text="Name, endpoint, and model are required!",
                            text_color=COLORS["danger"]).pack(pady=5)
                return

            if editing_llm_id[0]:
                # Update existing
                if update_llm(editing_llm_id[0], name, endpoint, model, api_key):
                    refresh_llm_list()
                    clear_form()
                else:
                    ctk.CTkLabel(form_content, text="Failed to update!",
                                text_color=COLORS["danger"]).pack(pady=5)
            else:
                # Add new
                if add_llm(name, endpoint, model, api_key):
                    refresh_llm_list()
                    clear_form()
                else:
                    ctk.CTkLabel(form_content, text="Failed to save!",
                                text_color=COLORS["danger"]).pack(pady=5)

        # Initial form state
        clear_form()

        # Initial refresh
        refresh_llm_list()

    def show_generator(self):
        """Show the script generator interface."""
        self.showing_generator = True
        self.current_script = None

        # Clear main area
        for widget in self.main_frame.winfo_children():
            widget.destroy()

        # Reconfigure main frame grid for generator
        self.main_frame.grid_rowconfigure(1, weight=1)
        self.main_frame.grid_columnconfigure(0, weight=1)

        # Create generator UI
        self.create_generator_ui()

        # Unhighlight any selected script in sidebar
        for name, btn in self.script_buttons.items():
            btn.configure(fg_color="transparent", text_color=COLORS["text_sub"])

    def create_generator_ui(self):
        """Create the script generator UI."""
        # Header
        header_frame = ctk.CTkFrame(self.main_frame, fg_color="transparent")
        header_frame.grid(row=0, column=0, sticky="ew", pady=(0, 20))

        ctk.CTkLabel(header_frame, text="ðŸ¤– Generate New Script",
                    font=ctk.CTkFont(family="Roboto", size=28, weight="bold"),
                    text_color=COLORS["text_main"], anchor="w").pack(fill="x")

        ctk.CTkLabel(header_frame, text="Describe the image processing script you want to create",
                    font=ctk.CTkFont(size=14), text_color=COLORS["text_sub"],
                    anchor="w", wraplength=800).pack(fill="x", pady=(5, 0))

        # Main Content Grid
        content_grid = ctk.CTkFrame(self.main_frame, fg_color="transparent")
        content_grid.grid(row=1, column=0, sticky="nsew")
        content_grid.grid_columnconfigure(0, weight=1)
        content_grid.grid_columnconfigure(1, weight=1)
        content_grid.grid_rowconfigure(0, weight=1)

        # Left Panel - Mode Selection
        left_panel = ctk.CTkFrame(content_grid, fg_color=COLORS["bg_card"], corner_radius=10, border_width=1, border_color=COLORS["border"])
        left_panel.grid(row=0, column=0, sticky="nsew", padx=(0, 10))

        left_header = ctk.CTkFrame(left_panel, fg_color="transparent")
        left_header.pack(fill="x", padx=15, pady=(15, 10))
        ctk.CTkLabel(left_header, text="Mode", font=ctk.CTkFont(size=15, weight="bold"),
                    text_color=COLORS["text_main"]).pack(side="left")

        left_content = ctk.CTkScrollableFrame(left_panel, fg_color="transparent")
        left_content.pack(fill="both", expand=True, padx=10, pady=5)

        # Mode selection
        mode_var = ctk.StringVar(value="create")
        self.generator_widgets["mode_var"] = mode_var

        create_frame = ctk.CTkFrame(left_content, fg_color=COLORS["bg_root"], corner_radius=8)
        create_frame.pack(fill="x", pady=5, padx=5)

        create_radio = ctk.CTkRadioButton(
            create_frame,
            text="Create New Script",
            variable=mode_var,
            value="create",
            font=ctk.CTkFont(size=13),
            fg_color="transparent",
            button_color=COLORS["accent"],
            button_hover_color=COLORS["accent_hover"],
            text_color=COLORS["text_main"],
            command=lambda: self._on_mode_change("create")
        )
        create_radio.pack(anchor="w", padx=10, pady=10)

        edit_frame = ctk.CTkFrame(left_content, fg_color=COLORS["bg_root"], corner_radius=8)
        edit_frame.pack(fill="x", pady=5, padx=5)

        edit_radio = ctk.CTkRadioButton(
            edit_frame,
            text="Edit Existing Script",
            variable=mode_var,
            value="edit",
            font=ctk.CTkFont(size=13),
            fg_color="transparent",
            button_color=COLORS["accent"],
            button_hover_color=COLORS["accent_hover"],
            text_color=COLORS["text_main"],
            command=lambda: self._on_mode_change("edit")
        )
        edit_radio.pack(anchor="w", padx=10, pady=10)

        # Script selection for edit mode (hidden by default)
        self.generator_widgets["script_select_frame"] = ctk.CTkFrame(left_content, fg_color="transparent")
        self.generator_widgets["script_select_frame"].pack(fill="x", pady=10, padx=5)

        ctk.CTkLabel(self.generator_widgets["script_select_frame"],
                    text="Select Script:",
                    font=ctk.CTkFont(size=11, weight="bold"),
                    text_color=COLORS["text_sub"], anchor="w").pack(fill="x", pady=(0, 5))

        script_names = [s["name"] for s in self.scripts]
        self.generator_widgets["script_selector"] = ctk.CTkOptionMenu(
            self.generator_widgets["script_select_frame"],
            values=script_names,
            fg_color=COLORS["bg_root"],
            button_color=COLORS["accent"]
        )
        self.generator_widgets["script_selector"].pack(fill="x")
        self.generator_widgets["script_select_frame"].pack_forget()  # Hide initially

        # Right Panel - Prompt Input
        right_panel = ctk.CTkFrame(content_grid, fg_color=COLORS["bg_card"], corner_radius=10, border_width=1, border_color=COLORS["border"])
        right_panel.grid(row=0, column=1, sticky="nsew", padx=(10, 0))

        right_header = ctk.CTkFrame(right_panel, fg_color="transparent")
        right_header.pack(fill="x", padx=15, pady=(15, 10))
        ctk.CTkLabel(right_header, text="Your Prompt", font=ctk.CTkFont(size=15, weight="bold"),
                    text_color=COLORS["text_main"]).pack(side="left")

        # Example prompts dropdown
        example_btn = ctk.CTkButton(
            right_header,
            text="Examples",
            width=80,
            height=25,
            font=ctk.CTkFont(size=11),
            fg_color=COLORS["bg_root"],
            hover_color=COLORS["border"],
            command=self._show_example_prompts
        )
        example_btn.pack(side="right")

        # Prompt text area
        self.generator_widgets["prompt_text"] = ctk.CTkTextbox(
            right_panel,
            fg_color=COLORS["bg_root"],
            border_color=COLORS["border"],
            font=ctk.CTkFont(size=13),
            wrap="word"
        )
        self.generator_widgets["prompt_text"].pack(fill="both", expand=True, padx=15, pady=(0, 15))

        # Placeholder text
        placeholder_text = """Describe the image processing script you want to create...

Examples:
â€¢ "Add a vintage film grain effect with adjustable intensity"
â€¢ "Create a script that generates polaroid-style frames"
â€¢ "Build a tool that adds timestamps to images with custom formatting"
â€¢ "Make a script that applies a duotone color effect with two color pickers"
"""
        self.generator_widgets["prompt_text"].insert("1.0", placeholder_text)

        # Action buttons
        action_frame = ctk.CTkFrame(right_panel, fg_color="transparent")
        action_frame.pack(fill="x", padx=15, pady=(0, 15))

        clear_btn = ctk.CTkButton(
            action_frame,
            text="Clear",
            width=80,
            command=lambda: self.generator_widgets["prompt_text"].delete("1.0", "end"),
            fg_color=COLORS["bg_root"],
            hover_color=COLORS["border"],
            text_color=COLORS["text_main"]
        )
        clear_btn.pack(side="left", padx=(0, 10))

        self.generator_widgets["generate_btn"] = ctk.CTkButton(
            action_frame,
            text="Generate Script",
            font=ctk.CTkFont(size=13, weight="bold"),
            command=self.generate_script,
            fg_color=COLORS["success"],
            hover_color=COLORS["success_hover"]
        )
        self.generator_widgets["generate_btn"].pack(side="right")

        # Keep console visible
        self.bottom_frame = ctk.CTkFrame(self.main_frame, fg_color="transparent")
        self.bottom_frame.grid(row=2, column=0, sticky="nsew", pady=(20, 0))
        self.bottom_frame.grid_rowconfigure(1, weight=1)
        self.bottom_frame.grid_columnconfigure(0, weight=1)

        # Console Header
        console_header = ctk.CTkFrame(self.bottom_frame, fg_color="transparent")
        console_header.grid(row=0, column=0, sticky="ew", pady=(0, 10))

        ctk.CTkLabel(console_header, text="Output Console",
                    font=ctk.CTkFont(size=14, weight="bold"),
                    text_color=COLORS["text_main"]).pack(side="left")

        # Console Window
        self.output_console = ctk.CTkTextbox(
            self.bottom_frame,
            font=("Consolas", 13),
            fg_color="#0f0f0f",
            text_color="#dcdcdc",
            border_width=1, border_color=COLORS["border"],
            height=200,
            activate_scrollbars=True
        )
        self.output_console.grid(row=1, column=0, sticky="nsew")
        self.output_console.insert("1.0", "Ready to generate scripts...\n")
        self.output_console.configure(state="disabled")

    def _on_mode_change(self, mode):
        """Handle mode radio button change."""
        if mode == "edit":
            self.generator_widgets["script_select_frame"].pack(fill="x", pady=10, padx=5)
        else:
            self.generator_widgets["script_select_frame"].pack_forget()

    def _show_example_prompts(self):
        """Show example prompts in a dropdown menu."""
        examples = [
            "Vintage film grain effect",
            "Polaroid-style frames",
            "Timestamp with custom formatting",
            "Duotone color effect",
            "Vignette with adjustable radius",
            "Color lookup table (LUT) application"
        ]

        # Create a simple dropdown using CTkOptionMenu in a temporary toplevel
        example_window = ctk.CTkToplevel(self)
        example_window.title("Example Prompts")
        example_window.geometry("400x300")
        example_window.configure(fg_color=COLORS["bg_card"])
        example_window.transient(self)
        example_window.grab_set()

        # Center
        example_window.update_idletasks()
        x = (example_window.winfo_screenwidth() // 2) - 200
        y = (example_window.winfo_screenheight() // 2) - 150
        example_window.geometry(f"400x300+{x}+{y}")

        ctk.CTkLabel(example_window, text="Select an Example",
                    font=ctk.CTkFont(size=16, weight="bold"),
                    text_color=COLORS["text_main"]).pack(pady=(20, 10))

        descriptions = [
            "Add a vintage film grain effect with adjustable intensity and grain size",
            "Create a script that generates polaroid-style frames with customizable borders",
            "Build a tool that adds timestamps to images with custom formatting options",
            "Apply a duotone color effect with two color pickers for highlights and shadows",
            "Add a vignette effect with adjustable radius and intensity controls",
            "Apply color grading using lookup tables (LUTs) for cinematic effects"
        ]

        for i, (title, desc) in enumerate(zip(examples, descriptions)):
            frame = ctk.CTkFrame(example_window, fg_color=COLORS["bg_root"], corner_radius=8)
            frame.pack(fill="x", padx=20, pady=5)

            def use_example(t=title, d=desc):
                self.generator_widgets["prompt_text"].delete("1.0", "end")
                self.generator_widgets["prompt_text"].insert("1.0", f"{d}")
                example_window.destroy()

            ctk.CTkLabel(frame, text=title, font=ctk.CTkFont(size=12, weight="bold"),
                        text_color=COLORS["text_main"], anchor="w").pack(fill="x", padx=10, pady=(8, 2))
            ctk.CTkLabel(frame, text=desc, font=ctk.CTkFont(size=10),
                        text_color=COLORS["text_sub"], anchor="w", wraplength=350).pack(fill="x", padx=10, pady=(0, 8))

            ctk.CTkButton(frame, text="Use This", width=70, height=24,
                          font=ctk.CTkFont(size=10),
                          fg_color=COLORS["accent"], hover_color=COLORS["accent_hover"],
                          command=use_example).pack(anchor="e", padx=10, pady=(0, 8))

        ctk.CTkButton(example_window, text="Close", command=example_window.destroy,
                     fg_color=COLORS["bg_root"], hover_color=COLORS["border"],
                     width=100).pack(pady=(10, 20))

    def generate_script(self):
        """Generate a script using the LLM API."""
        # Get prompt
        prompt = self.generator_widgets["prompt_text"].get("1.0", "end").strip()
        if not prompt or prompt.startswith("Describe the image processing"):
            self._log_to_console("âŒ Please enter a description of the script you want to create.")
            return

        # Check API config
        config = get_config()
        if not config.get("api_key"):
            self._log_to_console("âŒ API key not configured. Please open Settings (âš™) and enter your API key.")
            return

        # Get mode
        mode = self.generator_widgets["mode_var"].get()

        # Get existing script for edit mode
        existing_script_code = None
        if mode == "edit":
            script_name = self.generator_widgets["script_selector"].get()
            script = next((s for s in self.scripts if s["name"] == script_name), None)
            if script:
                script_path = os.path.join("scripts", f"{script['filename']}.py")
                try:
                    with open(script_path, "r") as f:
                        existing_script_code = f.read()
                except Exception as e:
                    self._log_to_console(f"âŒ Failed to load script: {e}")
                    return

        # Update UI state
        self.generator_widgets["generate_btn"].configure(
            state="disabled",
            text="Generating..."
        )
        self._log_to_console(f"ðŸ”„ Generating script in {mode} mode...")
        self._log_to_console(f"   Connecting to {config.get('model')} API...")

        # Run generation in background thread
        threading.Thread(
            target=self._run_generation,
            args=(prompt, mode, existing_script_code, config),
            daemon=True
        ).start()

    def _run_generation(self, prompt, mode, existing_script, config):
        """Run the actual generation in a background thread."""
        try:
            # Create generator
            generator = ScriptGenerator(
                endpoint=config["endpoint"],
                model=config["model"],
                api_key=config["api_key"]
            )

            self._log_to_console("   Sending request to LLM...")

            # Generate script
            result = generator.generate_script(
                user_prompt=prompt,
                existing_script=existing_script
            )

            self._log_to_console("   âœ“ Script generated successfully!")

            # Determine filename
            script_name_slug = ScriptGenerator.sanitize_filename(result["name"])
            script_filename = script_name_slug
            script_path = os.path.join("scripts", f"{script_filename}.py")

            # Save script
            with open(script_path, "w") as f:
                f.write(result["code"])

            self._log_to_console(f"   âœ“ Saved to: {script_path}")
            self._log_to_console(f"\nâœ… Script '{result['name']}' created successfully!")
            self._log_to_console(f"   {result['description']}")

            # Reload scripts and select the new one
            self.after(0, lambda: self._on_script_generated(script_filename))

        except APIError as e:
            self.after(0, lambda: self._log_to_console(f"\nâŒ API Error: {e}\n   Please check your API configuration and try again."))
            self.after(0, lambda: self.generator_widgets["generate_btn"].configure(
                state="normal", text="Generate Script", fg_color=COLORS["success"]
            ))

        except ValidationError as e:
            self.after(0, lambda: self._log_to_console(f"\nâŒ Validation Error: {e}"))
            self.after(0, lambda: self._log_to_console("   The generated script didn't meet requirements. Please try again."))
            self.after(0, lambda: self.generator_widgets["generate_btn"].configure(
                state="normal", text="Generate Script", fg_color=COLORS["success"]
            ))

        except Exception as e:
            self.after(0, lambda: self._log_to_console(f"\nâŒ Error: {e}"))
            self.after(0, lambda: self.generator_widgets["generate_btn"].configure(
                state="normal", text="Generate Script", fg_color=COLORS["success"]
            ))

    def _on_script_generated(self, script_filename):
        """Called after script generation is complete."""
        # Reload scripts
        self.scripts = self.get_scripts()

        # Find the new script
        new_script = next((s for s in self.scripts if s["filename"] == script_filename), None)
        if new_script:
            # Rebuild sidebar script list
            for widget in self.script_scroll.winfo_children():
                widget.destroy()
            self.script_buttons = {}

            for script in self.scripts:
                btn = ctk.CTkButton(
                    self.script_scroll,
                    text=f"  {script['name']}",
                    command=lambda s=script: self.load_script_details(s),
                    fg_color="transparent",
                    text_color=COLORS["text_sub"],
                    hover_color=COLORS["bg_card"],
                    anchor="w",
                    height=45,
                    font=ctk.CTkFont(size=13),
                    corner_radius=6
                )
                btn.pack(fill="x", pady=2)
                self.script_buttons[script['name']] = btn

            # Select the new script
            self.showing_generator = False
            self.load_script_details(new_script)

            # Reset generate button
            self.generator_widgets["generate_btn"].configure(
                state="normal",
                text="Generate Script",
                fg_color=COLORS["success"]
            )

    def _log_to_console(self, message):
        """Log a message to the output console."""
        if hasattr(self, 'output_console'):
            self.output_console.configure(state="normal")
            self.output_console.insert("end", message + "\n")
            self.output_console.see("end")
            self.output_console.configure(state="disabled")

if __name__ == "__main__":
    app = App()
    app.mainloop()